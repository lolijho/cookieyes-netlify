<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🍪 Test Cookie Banner - CookieYes Clone</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .test-section h2 {
            color: #4f46e5;
            border-bottom: 2px solid #4f46e5;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #3730a3;
            transform: translateY(-2px);
        }
        
        button.secondary {
            background: #6b7280;
        }
        
        button.danger {
            background: #ef4444;
        }
        
        .console-output {
            background: #1f2937;
            color: #10b981;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .script-urls {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .script-urls input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin: 5px 0;
            font-family: monospace;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .feature-card {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🍪 Test Cookie Banner System</h1>
        
        <div class="test-section">
            <h2>📋 Script di Test Disponibili</h2>
            <p>Puoi testare il cookie banner usando questi script di progetti di esempio:</p>
            
            <div class="script-urls">
                <div>
                    <strong>Progetto Default:</strong>
                    <input type="text" value="<script src='/api/script/project_default' async></script>" readonly onclick="this.select()">
                </div>
                <div>
                    <strong>Progetto Test (se hai progetti creati):</strong>
                    <input type="text" id="custom-script" placeholder="<script src='/api/script/YOUR_PROJECT_ID' async></script>" readonly onclick="this.select()">
                </div>
            </div>
            
            <button onclick="loadCookieScript()">🚀 Carica Cookie Banner</button>
            <button onclick="clearCookieConsent()" class="secondary">🧹 Reset Consensi</button>
            <button onclick="showConsentStatus()" class="secondary">📊 Mostra Status</button>
        </div>

        <div class="test-section">
            <h2>🍪 Cookie Scanner in Tempo Reale</h2>
            <p>Questo scanner mostra tutti i cookie presenti nel browser e li categorizza automaticamente:</p>
            
            <div id="cookie-scan-results" class="console-output">
                Clicca "Scansiona Cookie" per iniziare...
            </div>
            
            <button onclick="scanCurrentCookies()">🔍 Scansiona Cookie</button>
            <button onclick="addTestCookies()" class="secondary">➕ Aggiungi Cookie di Test</button>
            <button onclick="clearAllCookies()" class="danger">🗑️ Cancella Tutti i Cookie</button>
        </div>

        <div class="test-section">
            <h2>🎯 Features Implementate</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">🔍</div>
                    <h3>Cookie Scanner</h3>
                    <p>Scansiona automaticamente tutti i cookie presenti e li categorizza</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🎨</div>
                    <h3>Banner Personalizzabile</h3>
                    <p>Editor visuale per personalizzare colori, testi e layout</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">📱</div>
                    <h3>Responsive Design</h3>
                    <p>Banner ottimizzato per desktop e mobile</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">⚡</div>
                    <h3>Google Consent Mode</h3>
                    <p>Integrazione automatica con Google Analytics</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🔒</div>
                    <h3>GDPR Compliant</h3>
                    <p>Gestione completa dei consensi secondo GDPR</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">💾</div>
                    <h3>Backup Cloud</h3>
                    <p>Sincronizzazione automatica con Turso Database</p>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>🎛️ Test Modal Preferenze (NUOVO!)</h2>
            <div class="info-box" style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; padding: 20px; border-radius: 12px; margin: 20px 0;">
                <h3 style="margin: 0 0 10px 0;">✨ Modal Preferenze Rinnovato!</h3>
                <p style="margin: 0;">Il banner ora include un modal moderno per personalizzare i consensi cookie con design professionale e toggle switches!</p>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h4>🎯 Come testare il nuovo modal:</h4>
                <ol>
                    <li>Clicca <strong>"Carica Cookie Banner"</strong> sopra per attivare il banner</li>
                    <li>Nel banner, clicca il pulsante <strong>"Personalizza"</strong></li>
                    <li>Esplora il nuovo modal con:</li>
                    <ul>
                        <li>🎨 Header con gradiente colorato</li>
                        <li>🔘 Toggle switches moderni per ogni categoria</li>
                        <li>📝 Descrizioni dettagliate di ogni tipo di cookie</li>
                        <li>🎯 Pulsanti multipli: "Salva", "Accetta Tutti", "Rifiuta"</li>
                        <li>✕ Pulsante di chiusura in alto a destra</li>
                        <li>📱 Design completamente responsive</li>
                    </ul>
                </ol>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin: 20px 0;">
                <button onclick="testPreferencesModal()" style="background: #4f46e5; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    🎨 Mostra Modal Preferenze
                </button>
                <button onclick="clearCookieConsent(); setTimeout(loadCookieScript, 100);" style="background: #10b981; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    🔄 Reset + Ricarica Banner
                </button>
            </div>
        </div>

        <div class="test-section">
            <h2>📊 Cookie Consent Status</h2>
            <div id="consent-status" class="console-output">
                Nessun consenso trovato. Carica il cookie banner per iniziare.
            </div>
        </div>

        <div class="test-section">
            <h2>🧪 Console Log</h2>
            <div id="console-log" class="console-output">
                Logs del sistema appariranno qui...
            </div>
        </div>
    </div>

    <script>
        // Override console.log per mostrare i log nella pagina
        var originalLog = console.log;
        var logElement = document.getElementById('console-log');
        
        console.log = function() {
            originalLog.apply(console, arguments);
            var timestamp = new Date().toLocaleTimeString();
            var message = Array.prototype.slice.call(arguments).map(function(arg) {
                return typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg);
            }).join(' ');
            logElement.textContent += '[' + timestamp + '] ' + message + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        };

        // Funzione per caricare il cookie script
        function loadCookieScript() {
            // Rimuovi script precedenti
            var existingScript = document.querySelector('script[src*="/api/script/"]');
            if (existingScript) {
                existingScript.remove();
            }

            // Carica nuovo script
            var script = document.createElement('script');
            script.src = '/api/script/project_default';
            script.async = true;
            script.onload = function() {
                console.log('✅ Cookie script caricato con successo!');
                setTimeout(showConsentStatus, 1000);
            };
            script.onerror = function() {
                console.log('❌ Errore nel caricamento dello script');
            };
            document.head.appendChild(script);
        }

        // Funzione per cancellare i consensi
        function clearCookieConsent() {
            Object.keys(localStorage).forEach(function(key) {
                if (key.indexOf('cookie_consent_') === 0) {
                    localStorage.removeItem(key);
                }
            });
            
            // Rimuovi anche il banner se presente
            var banner = document.getElementById('cookie-banner');
            if (banner) {
                banner.remove();
            }
            
            console.log('🧹 Consensi cookie cancellati');
            showConsentStatus();
        }

        // Funzione per mostrare lo status dei consensi
        function showConsentStatus() {
            var statusElement = document.getElementById('consent-status');
            var status = '';
            
            Object.keys(localStorage).forEach(function(key) {
                if (key.indexOf('cookie_consent_') === 0) {
                    var projectId = key.replace('cookie_consent_', '');
                    var consent = JSON.parse(localStorage.getItem(key));
                    status += '🎯 Progetto: ' + projectId + '\n';
                    status += '⏰ Consenso dato: ' + new Date(consent.timestamp).toLocaleString() + '\n';
                    status += '📋 Consensi:\n';
                    status += '  🔒 Necessari: ' + (consent.necessary ? '✅' : '❌') + '\n';
                    status += '  📊 Analytics: ' + (consent.analytics ? '✅' : '❌') + '\n';
                    status += '  📢 Marketing: ' + (consent.marketing ? '✅' : '❌') + '\n';
                    status += '  ⚙️ Preferenze: ' + (consent.preferences ? '✅' : '❌') + '\n\n';
                }
            });
            
            if (!status) {
                status = 'Nessun consenso cookie trovato';
            }
            
            statusElement.textContent = status;
            console.log('📊 Status consensi aggiornato');
        }

        // Funzione per scansionare i cookie attuali
        function scanCurrentCookies() {
            var scanElement = document.getElementById('cookie-scan-results');
            var results = '🔍 SCANSIONE COOKIE COMPLETATA\n\n';
            
            // Scansiona cookie del browser
            var cookies = document.cookie.split(';').filter(function(cookie) {
                return cookie.trim();
            });
            results += '📊 Cookie trovati: ' + cookies.length + '\n\n';
            
            if (cookies.length === 0) {
                results += 'Nessun cookie presente\n';
            } else {
                cookies.forEach(function(cookie) {
                    var parts = cookie.trim().split('=');
                    var name = parts[0];
                    var category = categorizeCookie(name);
                    var emoji = getCategoryEmoji(category);
                    results += emoji + ' ' + name + ': ' + category + '\n';
                });
            }
            
            // Scansiona localStorage
            results += '\n💾 LOCAL STORAGE:\n';
            for (var i = 0; i < localStorage.length; i++) {
                var key = localStorage.key(i);
                var category = categorizeCookie(key);
                var emoji = getCategoryEmoji(category);
                results += emoji + ' ' + key + ': ' + category + '\n';
            }
            
            // Scansiona sessionStorage
            results += '\n⚡ SESSION STORAGE:\n';
            for (var i = 0; i < sessionStorage.length; i++) {
                var key = sessionStorage.key(i);
                var category = categorizeCookie(key);
                var emoji = getCategoryEmoji(category);
                results += emoji + ' ' + key + ': ' + category + '\n';
            }
            
            scanElement.textContent = results;
            console.log('🔍 Scansione cookie completata');
        }

        // Funzione per categorizzare i cookie
        function categorizeCookie(name) {
            if (!name) return 'unknown';
            
            var lowerName = name.toLowerCase();
            
            if (lowerName.indexOf('session') !== -1 || lowerName.indexOf('csrf') !== -1 || 
                lowerName.indexOf('auth') !== -1 || lowerName.indexOf('security') !== -1) {
                return 'necessary';
            }
            if (lowerName.indexOf('ga') !== -1 || lowerName.indexOf('analytics') !== -1 || 
                lowerName.indexOf('gtm') !== -1 || lowerName.indexOf('_utm') !== -1) {
                return 'analytics';
            }
            if (lowerName.indexOf('fb') !== -1 || lowerName.indexOf('ads') !== -1 || 
                lowerName.indexOf('marketing') !== -1 || lowerName.indexOf('track') !== -1) {
                return 'marketing';
            }
            if (lowerName.indexOf('pref') !== -1 || lowerName.indexOf('settings') !== -1 || 
                lowerName.indexOf('lang') !== -1 || lowerName.indexOf('theme') !== -1) {
                return 'preferences';
            }
            
            return 'necessary';
        }

        // Funzione per ottenere emoji per categoria
        function getCategoryEmoji(category) {
            switch (category) {
                case 'necessary': return '🔒';
                case 'analytics': return '📊';
                case 'marketing': return '📢';
                case 'preferences': return '⚙️';
                default: return '❓';
            }
        }

        // Funzione per aggiungere cookie di test
        function addTestCookies() {
            document.cookie = 'test_session=abc123; path=/';
            document.cookie = 'ga_test=analytics_data; path=/';
            document.cookie = 'fb_tracking=marketing_pixel; path=/';
            document.cookie = 'user_preferences=dark_theme; path=/';
            
            localStorage.setItem('test_analytics_data', 'user_behavior');
            localStorage.setItem('user_settings', JSON.stringify({ theme: 'dark', lang: 'it' }));
            localStorage.setItem('marketing_consent', 'granted');
            
            sessionStorage.setItem('session_temp', 'temp_data');
            sessionStorage.setItem('csrf_token', 'security_token_123');
            
            console.log('➕ Cookie di test aggiunti');
            scanCurrentCookies();
        }

        // Funzione per cancellare tutti i cookie
        function clearAllCookies() {
            // Cancella tutti i cookie
            document.cookie.split(";").forEach(function(cookie) {
                var eqPos = cookie.indexOf("=");
                var name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=" + window.location.hostname;
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=." + window.location.hostname;
            });
            
            // Cancella localStorage (tranne i consensi)
            Object.keys(localStorage).forEach(function(key) {
                if (key.indexOf('cookie_consent_') !== 0) {
                    localStorage.removeItem(key);
                }
            });
            
            // Cancella sessionStorage
            sessionStorage.clear();
            
            console.log('🗑️ Tutti i cookie e storage cancellati');
            scanCurrentCookies();
        }

        // Carica automaticamente lo status all'avvio
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Pagina di test caricata');
            console.log('💡 Usa i pulsanti per testare il sistema di cookie');
            
            showConsentStatus();
            scanCurrentCookies();
            
            // Imposta un ID progetto personalizzato se disponibile nei parametri URL
            var urlParams = new URLSearchParams(window.location.search);
            var projectId = urlParams.get('project');
            if (projectId) {
                document.getElementById('custom-script').value = '<script src="/api/script/' + projectId + '" async></script>';
                console.log('🎯 Progetto personalizzato impostato: ' + projectId);
            }
        });

        // Funzione per testare il modal delle preferenze
        function testPreferencesModal() {
            // Prima assicurati che il banner sia presente
            var banner = document.getElementById('cookie-banner');
            if (!banner) {
                console.log('⚠️ Banner non trovato. Caricando...');
                loadCookieScript();
                setTimeout(function() {
                    activatePreferencesModal();
                }, 2000);
            } else {
                activatePreferencesModal();
            }
        }

        function activatePreferencesModal() {
            var settingsBtn = document.querySelector('#cookie-settings');
            if (settingsBtn) {
                console.log('🎨 Aprendo modal preferenze...');
                settingsBtn.click();
            } else {
                console.log('❌ Pulsante Personalizza non trovato');
            }
        }

        // Esponi funzioni globali per debug
        window.CookieTest = {
            loadScript: loadCookieScript,
            clearConsent: clearCookieConsent,
            showStatus: showConsentStatus,
            scanCookies: scanCurrentCookies,
            addTestCookies: addTestCookies,
            clearAllCookies: clearAllCookies,
            testModal: testPreferencesModal
        };
    </script>
</body>
</html> 