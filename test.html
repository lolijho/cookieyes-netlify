<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÔøΩÔøΩ Test Cookie Banner System 2.0 - Versione Migliorata</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            background: #f8fafc;
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #e2e8f0;
        }
        
        .test-section h2 {
            color: #1e40af;
            margin-bottom: 15px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-section p {
            margin-bottom: 20px;
            line-height: 1.6;
            color: #64748b;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }
        
        .secondary {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
        }
        
        .success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .console-output {
            background: #1e293b;
            color: #64748b;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 20px 0;
            border: 1px solid #334155;
        }
        
        .console-output::-webkit-scrollbar {
            width: 8px;
        }
        
        .console-output::-webkit-scrollbar-track {
            background: #0f172a;
            border-radius: 4px;
        }
        
        .console-output::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        
        .status-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .status-card.active {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .status-card.blocked {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .script-demo {
            background: #f1f5f9;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #3b82f6;
            margin: 15px 0;
        }
        
        .script-demo h4 {
            color: #1e40af;
            margin-bottom: 10px;
        }
        
        .script-demo pre {
            background: #0f172a;
            color: #64748b;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .api-info {
            background: linear-gradient(135deg, #ddd6fe 0%, #c084fc 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .api-info h3 {
            color: #4c1d95;
            margin-bottom: 10px;
        }
        
        .api-info code {
            background: rgba(255,255,255,0.8);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #1e40af;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .realtime-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #10b981;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .cookie-category {
            padding: 10px;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 0.9rem;
        }
        
        .category-necessary { background: #dcfce7; border-left: 4px solid #10b981; }
        .category-analytics { background: #dbeafe; border-left: 4px solid #3b82f6; }
        .category-marketing { background: #fef3c7; border-left: 4px solid #f59e0b; }
        .category-preferences { background: #f3e8ff; border-left: 4px solid #8b5cf6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üç™ Test Cookie Banner System 2.0</h1>
            <p><span class="realtime-indicator"></span>Sistema di gestione cookie avanzato con scan e blocco intelligente</p>
        </div>
        
        <div class="content">
            <!-- Sistema di controllo -->
            <div class="test-section">
                <h2>üéÆ Controlli Sistema</h2>
                <p>Gestisci il cookie banner e monitora il sistema in tempo reale</p>
                
                <div class="button-group">
                    <button onclick="loadCookieScript()" class="primary">
                        üöÄ Carica Cookie Banner
                    </button>
                    <button onclick="clearCookieConsent()" class="warning">
                        üßπ Reset Consensi
                    </button>
                    <button onclick="showConsentStatus()" class="secondary">
                        üìä Mostra Status
                    </button>
                    <button onclick="toggleMonitoring()" class="success" id="monitoring-btn">
                        üëÄ Avvia Monitoraggio
                    </button>
                </div>
                
                <div id="console-log" class="console-output">
                    üöÄ Sistema di test caricato. Clicca sui pulsanti per iniziare...
                </div>
            </div>
            
            <!-- Test Script con data-cookie-category -->
            <div class="test-section">
                <h2>üß™ Test Script con Categorie</h2>
                <p>Verifica il blocco intelligente degli script basato sui consensi</p>
                
                <div class="button-group">
                    <button onclick="addTestScripts()" class="primary">
                        ‚ûï Aggiungi Script Test
                    </button>
                    <button onclick="removeTestScripts()" class="danger">
                        üóëÔ∏è Rimuovi Script Test
                    </button>
                    <button onclick="scanScripts()" class="secondary">
                        üîç Scansiona Script
                    </button>
                </div>
                
                <div class="script-demo">
                    <h4>üìù Esempi di Script con Categorie:</h4>
                    <pre><code>&lt;script type="text/plain" data-cookie-category="analytics"&gt;
// Google Analytics
console.log('GA Script eseguito!');
&lt;/script&gt;

&lt;script type="text/plain" data-cookie-category="marketing"&gt;
// Facebook Pixel
console.log('FB Pixel eseguito!');
&lt;/script&gt;

&lt;script type="text/plain" data-cookie-category="preferences"&gt;
// Script preferenze utente
console.log('Preferenze caricate!');
&lt;/script&gt;</code></pre>
                </div>
                
                <div id="script-status" class="stats-grid"></div>
            </div>
            
            <!-- Scanner Cookie Avanzato -->
            <div class="test-section">
                <h2>üîç Scanner Cookie Avanzato</h2>
                <p>Scansiona e categorizza automaticamente cookie, localStorage, sessionStorage e script</p>
                
                <div class="button-group">
                    <button onclick="scanEverything()" class="primary">
                        üîç Scan Completo
                    </button>
                    <button onclick="addTestCookies()" class="success">
                        ‚ûï Aggiungi Cookie Test
                    </button>
                    <button onclick="clearAllCookies()" class="danger">
                        üóëÔ∏è Cancella Tutto
                    </button>
                    <button onclick="exportScanResults()" class="secondary">
                        üíæ Esporta Risultati
                    </button>
                </div>
                
                <div id="scan-results" class="console-output">
                    Clicca "Scan Completo" per iniziare la scansione...
                </div>
                
                <div id="scan-summary" class="stats-grid"></div>
            </div>
            
            <!-- API e Integrazioni -->
            <div class="test-section">
                <h2>üîó API e Integrazioni</h2>
                <p>Testa l'API avanzata del sistema cookie</p>
                
                <div class="button-group">
                    <button onclick="testAPI()" class="primary">
                        üß™ Test API
                    </button>
                    <button onclick="showGoogleConsentMode()" class="secondary">
                        üéØ Google Consent Mode
                    </button>
                    <button onclick="simulateTrackingScripts()" class="warning">
                        üìä Simula Tracking
                    </button>
                </div>
                
                <div class="api-info">
                    <h3>üí° API Disponibili</h3>
                    <p>Dopo il caricamento del banner, puoi usare:</p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><code>window.CookieConsent.scanCookies()</code> - Scansiona tutto</li>
                        <li><code>window.CookieConsent.getConsent()</code> - Ottieni consensi</li>
                        <li><code>window.CookieConsent.startMonitoring()</code> - Avvia monitoraggio</li>
                        <li><code>window.CookieConsent.getLastScan()</code> - Ultimi risultati</li>
                        <li><code>window.CookieConsent.getProjectInfo()</code> - Info progetto</li>
                    </ul>
                </div>
                
                <div id="api-results" class="console-output"></div>
            </div>
            
            <!-- Monitoraggio Real-time -->
            <div class="test-section">
                <h2>üìä Monitoraggio Real-time</h2>
                <p>Visualizza i cambiamenti nei cookie e script in tempo reale</p>
                
                <div id="realtime-stats" class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="cookie-count">-</div>
                        <div class="stat-label">Cookie Totali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="script-count">-</div>
                        <div class="stat-label">Script Totali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="blocked-count">-</div>
                        <div class="stat-label">Elementi Bloccati</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="consent-status">-</div>
                        <div class="stat-label">Stato Consenso</div>
                    </div>
                </div>
                
                <div id="realtime-log" class="console-output"></div>
            </div>
        </div>
    </div>
    
    <!-- Script di test che verranno bloccati -->
    <script type="text/plain" data-cookie-category="analytics" id="test-analytics">
        console.log('‚úÖ ANALYTICS SCRIPT ATTIVO - Google Analytics simulato');
        // Simula GA
        window.testAnalytics = true;
    </script>
    
    <script type="text/plain" data-cookie-category="marketing" id="test-marketing">
        console.log('‚úÖ MARKETING SCRIPT ATTIVO - Facebook Pixel simulato');
        // Simula FB Pixel
        window.testMarketing = true;
    </script>
    
    <script type="text/plain" data-cookie-category="preferences" id="test-preferences">
        console.log('‚úÖ PREFERENCES SCRIPT ATTIVO - Preferenze utente');
        // Simula preferenze
        window.testPreferences = true;
    </script>
    
    <script>
        // Variabili globali
        let monitoringActive = false;
        let monitoringInterval = null;
        let scanHistory = [];
        
        // Override console.log per mostrare i log nella pagina
        const originalLog = console.log;
        const logElement = document.getElementById('console-log');
        
        console.log = function() {
            originalLog.apply(console, arguments);
            const timestamp = new Date().toLocaleTimeString();
            const message = Array.prototype.slice.call(arguments).map(function(arg) {
                return typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg);
            }).join(' ');
            logElement.textContent += '[' + timestamp + '] ' + message + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        };
        
        // Funzione per caricare il cookie script
        function loadCookieScript() {
            // Rimuovi script precedenti
            const existingScript = document.querySelector('script[src*="/api/script/"]');
            if (existingScript) {
                existingScript.remove();
            }
            
            // Carica nuovo script
            const script = document.createElement('script');
            script.src = '/api/script/project_default';
            script.async = true;
            script.onload = function() {
                console.log('‚úÖ Cookie script caricato con successo!');
                
                // Attende l'evento di inizializzazione
                window.addEventListener('cookieSystemReady', function(e) {
                    console.log('üöÄ Sistema cookie completamente pronto!');
                    console.log('üìä Dettagli:', e.detail);
                    updateRealtimeStats();
                    
                    // Avvia monitoraggio automatico
                    if (window.CookieConsent) {
                        startRealtimeMonitoring();
                    }
                });
                
                setTimeout(showConsentStatus, 1000);
            };
            script.onerror = function() {
                console.log('‚ùå Errore nel caricamento dello script');
            };
            document.head.appendChild(script);
        }
        
        // Funzione per cancellare i consensi
        function clearCookieConsent() {
            // Rimuovi tutti i cookie di consenso
            const cookies = document.cookie.split(';');
            cookies.forEach(cookie => {
                const name = cookie.split('=')[0].trim();
                if (name.startsWith('cookie_consent_')) {
                    document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                }
            });
            
            // Rimuovi dal localStorage
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('cookie_consent_')) {
                    localStorage.removeItem(key);
                }
            });
            
            console.log('üßπ Consensi rimossi completamente');
            
            // Ricarica la pagina per testare di nuovo
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
        
        // Funzione per mostrare lo status dei consensi
        function showConsentStatus() {
            if (window.CookieConsent) {
                const consent = window.CookieConsent.getConsent();
                const hasConsent = window.CookieConsent.hasConsent();
                const projectInfo = window.CookieConsent.getProjectInfo();
                
                console.log('üìä STATUS CONSENSI:');
                console.log('- Ha consenso:', hasConsent);
                console.log('- Dettagli consenso:', consent);
                console.log('- Info progetto:', projectInfo);
                
                // Aggiorna stats
                updateRealtimeStats();
            } else {
                console.log('‚ö†Ô∏è Sistema cookie non ancora caricato');
            }
        }
        
        // Funzione per aggiungere script di test
        function addTestScripts() {
            const scripts = [
                { category: 'analytics', content: 'console.log("üìä Google Analytics Test"); window.gaTest = true;' },
                { category: 'marketing', content: 'console.log("üì¢ Facebook Pixel Test"); window.fbTest = true;' },
                { category: 'preferences', content: 'console.log("‚öôÔ∏è Preferenze Test"); window.prefTest = true;' }
            ];
            
            scripts.forEach((scriptData, index) => {
                const script = document.createElement('script');
                script.type = 'text/plain';
                script.dataset.cookieCategory = scriptData.category;
                script.id = 'dynamic-test-' + scriptData.category;
                script.textContent = scriptData.content;
                document.head.appendChild(script);
            });
            
            console.log('‚ûï Script di test aggiunti con successo');
            
            // Riprocessa gli script se il sistema √® attivo
            if (window.CookieConsent) {
                setTimeout(() => {
                    scanScripts();
                }, 500);
            }
        }
        
        // Funzione per rimuovere script di test
        function removeTestScripts() {
            const testScripts = document.querySelectorAll('script[id^="dynamic-test-"]');
            testScripts.forEach(script => script.remove());
            
            console.log('üóëÔ∏è Script di test rimossi');
            scanScripts();
        }
        
        // Funzione per scansionare script
        function scanScripts() {
            if (window.CookieConsent) {
                const results = window.CookieConsent.scanCookies();
                const scripts = results.scripts;
                
                console.log('üîç SCANSIONE SCRIPT:');
                console.log('- Totali:', scripts.total);
                console.log('- Attivi:', scripts.active);
                console.log('- Bloccati:', scripts.blocked);
                console.log('- Per categoria:', scripts.byCategory);
                
                // Mostra status visivo
                updateScriptStatus(scripts);
            } else {
                console.log('‚ö†Ô∏è Sistema cookie non disponibile');
            }
        }
        
        // Funzione per aggiornare lo status degli script
        function updateScriptStatus(scripts) {
            const statusDiv = document.getElementById('script-status');
            statusDiv.innerHTML = '';
            
            Object.entries(scripts.byCategory).forEach(([category, scriptList]) => {
                if (scriptList.length > 0) {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <div class="stat-number">${scriptList.length}</div>
                        <div class="stat-label">${category.toUpperCase()}</div>
                    `;
                    statusDiv.appendChild(card);
                }
            });
        }
        
        // Funzione per scansione completa
        function scanEverything() {
            if (window.CookieConsent) {
                const results = window.CookieConsent.scanCookies();
                console.log('üîç SCANSIONE COMPLETA AVVIATA');
                
                // Mostra risultati dettagliati
                const output = document.getElementById('scan-results');
                output.textContent = `
üîç RISULTATI SCANSIONE COMPLETA
===============================

üìä RIEPILOGO:
- Cookie: ${results.summary.cookies.total}
- Storage: ${results.summary.storage.total}
- Script: ${results.summary.scripts.total}
- Bloccati: ${results.summary.scripts.blocked}

üç™ COOKIE PER CATEGORIA:
${Object.entries(results.summary.cookies.byCategory).map(([cat, count]) => `- ${cat}: ${count}`).join('\n')}

üíæ STORAGE:
- localStorage: ${results.summary.storage.localStorage}
- sessionStorage: ${results.summary.storage.sessionStorage}

üìú SCRIPT:
- Attivi: ${results.summary.scripts.active}
- Bloccati: ${results.summary.scripts.blocked}

üîç DETTAGLI COOKIE:
${Object.entries(results.cookies).map(([name, data]) => `- ${name} [${data.category}]: ${data.value.substring(0, 50)}...`).join('\n')}
                `;
                
                // Aggiorna statistiche
                updateScanSummary(results.summary);
                
                // Salva nella cronologia
                scanHistory.push({
                    timestamp: new Date().toLocaleTimeString(),
                    results: results
                });
                
                console.log('‚úÖ Scansione completata');
            } else {
                console.log('‚ö†Ô∏è Sistema cookie non disponibile');
            }
        }
        
        // Funzione per aggiornare il sommario della scansione
        function updateScanSummary(summary) {
            const summaryDiv = document.getElementById('scan-summary');
            summaryDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${summary.cookies.total}</div>
                    <div class="stat-label">Cookie</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${summary.storage.total}</div>
                    <div class="stat-label">Storage Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${summary.scripts.total}</div>
                    <div class="stat-label">Script</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${summary.scripts.blocked}</div>
                    <div class="stat-label">Bloccati</div>
                </div>
            `;
        }
        
        // Funzione per aggiungere cookie di test
        function addTestCookies() {
            const testCookies = [
                { name: 'test_session', value: 'abc123', category: 'necessary' },
                { name: '_ga_test', value: 'GA1.2.123456789', category: 'analytics' },
                { name: '_fbp_test', value: 'fb.1.123456789', category: 'marketing' },
                { name: 'user_theme', value: 'dark', category: 'preferences' }
            ];
            
            testCookies.forEach(cookie => {
                document.cookie = `${cookie.name}=${cookie.value}; path=/; max-age=3600`;
            });
            
            // Aggiungi anche al localStorage
            localStorage.setItem('test_analytics_data', JSON.stringify({user: 'test', events: 123}));
            localStorage.setItem('user_preferences', JSON.stringify({theme: 'dark', lang: 'it'}));
            localStorage.setItem('marketing_consent', 'granted');
            
            // Aggiungi al sessionStorage
            sessionStorage.setItem('session_temp', 'temp_data_123');
            sessionStorage.setItem('csrf_token', 'security_token_abc123');
            
            console.log('‚ûï Cookie e storage di test aggiunti');
            
            // Scansiona automaticamente
            setTimeout(scanEverything, 500);
        }
        
        // Funzione per cancellare tutto
        function clearAllCookies() {
            // Cancella tutti i cookie
            document.cookie.split(";").forEach(function(cookie) {
                const eqPos = cookie.indexOf("=");
                const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
                if (name && !name.startsWith('cookie_consent_')) {
                    document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
                    document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=" + window.location.hostname;
                    document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=." + window.location.hostname;
                }
            });
            
            // Cancella localStorage (tranne consensi)
            Object.keys(localStorage).forEach(function(key) {
                if (!key.startsWith('cookie_consent_')) {
                    localStorage.removeItem(key);
                }
            });
            
            // Cancella sessionStorage
            sessionStorage.clear();
            
            console.log('üóëÔ∏è Tutti i cookie e storage cancellati (consensi preservati)');
            
            // Scansiona per verificare
            setTimeout(scanEverything, 500);
        }
        
        // Funzione per esportare i risultati
        function exportScanResults() {
            if (scanHistory.length === 0) {
                console.log('‚ö†Ô∏è Nessun risultato da esportare');
                return;
            }
            
            const exportData = {
                timestamp: new Date().toISOString(),
                scanHistory: scanHistory,
                currentStatus: window.CookieConsent ? window.CookieConsent.getLastScan() : null
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'cookie-scan-results-' + new Date().toISOString().slice(0, 10) + '.json';
            link.click();
            
            URL.revokeObjectURL(url);
            console.log('üíæ Risultati esportati con successo');
        }
        
        // Funzione per testare l'API
        function testAPI() {
            if (!window.CookieConsent) {
                console.log('‚ö†Ô∏è API non disponibile');
                return;
            }
            
            const apiResults = document.getElementById('api-results');
            
            try {
                const tests = [
                    { name: 'getProjectInfo', result: window.CookieConsent.getProjectInfo() },
                    { name: 'hasConsent', result: window.CookieConsent.hasConsent() },
                    { name: 'getConsent', result: window.CookieConsent.getConsent() },
                    { name: 'getLastScan', result: window.CookieConsent.getLastScan() }
                ];
                
                let output = 'üß™ TEST API COMPLETATI\n===================\n\n';
                
                tests.forEach(test => {
                    output += `‚úÖ ${test.name}:\n`;
                    output += JSON.stringify(test.result, null, 2) + '\n\n';
                });
                
                apiResults.textContent = output;
                console.log('üß™ Test API completati con successo');
                
            } catch (error) {
                console.log('‚ùå Errore durante i test API:', error);
                apiResults.textContent = 'Errore durante i test API: ' + error.message;
            }
        }
        
        // Funzione per mostrare Google Consent Mode
        function showGoogleConsentMode() {
            console.log('üéØ GOOGLE CONSENT MODE STATUS:');
            
            if (typeof gtag !== 'undefined') {
                console.log('‚úÖ Google gtag disponibile');
                
                // Mostra lo stato del dataLayer
                if (window.dataLayer) {
                    console.log('üìä DataLayer entries:', window.dataLayer.length);
                    
                    // Trova le entries di consent
                    const consentEntries = window.dataLayer.filter(entry => 
                        entry && entry[0] === 'consent'
                    );
                    
                    console.log('üîç Consent entries:', consentEntries);
                } else {
                    console.log('‚ö†Ô∏è DataLayer non disponibile');
                }
            } else {
                console.log('‚ö†Ô∏è Google gtag non disponibile');
            }
        }
        
        // Funzione per simulare script di tracking
        function simulateTrackingScripts() {
            const trackingScripts = [
                'https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID',
                'https://connect.facebook.net/en_US/fbevents.js',
                'https://www.googleadservices.com/pagead/conversion_async.js'
            ];
            
            trackingScripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.dataset.cookieCategory = 'marketing';
                
                // Non aggiungere realmente al DOM, solo testare il blocco
                console.log('üß™ Simulando caricamento script:', src);
                
                // Testa se verrebbe bloccato
                if (window.CookieConsent) {
                    const isBlocked = window.CookieConsent.isBlocked(src);
                    console.log('- Bloccato:', isBlocked);
                }
            });
        }
        
        // Funzione per toggle monitoraggio
        function toggleMonitoring() {
            const btn = document.getElementById('monitoring-btn');
            
            if (monitoringActive) {
                stopRealtimeMonitoring();
                btn.textContent = 'üëÄ Avvia Monitoraggio';
                btn.className = 'success';
            } else {
                startRealtimeMonitoring();
                btn.textContent = '‚èπÔ∏è Ferma Monitoraggio';
                btn.className = 'danger';
            }
        }
        
        // Funzione per avviare monitoraggio real-time
        function startRealtimeMonitoring() {
            if (monitoringActive) return;
            
            monitoringActive = true;
            console.log('üëÄ Monitoraggio real-time avviato');
            
            monitoringInterval = setInterval(() => {
                updateRealtimeStats();
                logRealtimeChanges();
            }, 2000);
        }
        
        // Funzione per fermare monitoraggio real-time
        function stopRealtimeMonitoring() {
            if (!monitoringActive) return;
            
            monitoringActive = false;
            clearInterval(monitoringInterval);
            console.log('‚èπÔ∏è Monitoraggio real-time fermato');
        }
        
        // Funzione per aggiornare statistiche real-time
        function updateRealtimeStats() {
            const cookieCount = document.cookie.split(';').filter(c => c.trim()).length;
            const scriptCount = document.querySelectorAll('script').length;
            const blockedCount = document.querySelectorAll('script[data-blocked="true"]').length;
            
            let consentStatus = 'Nessuno';
            if (window.CookieConsent) {
                const consent = window.CookieConsent.getConsent();
                if (consent) {
                    const granted = Object.values(consent).filter(v => v === true).length;
                    consentStatus = `${granted}/4`;
                }
            }
            
            document.getElementById('cookie-count').textContent = cookieCount;
            document.getElementById('script-count').textContent = scriptCount;
            document.getElementById('blocked-count').textContent = blockedCount;
            document.getElementById('consent-status').textContent = consentStatus;
        }
        
        // Funzione per loggare cambiamenti real-time
        function logRealtimeChanges() {
            if (!window.CookieConsent) return;
            
            const currentScan = window.CookieConsent.getLastScan();
            if (!currentScan) return;
            
            const logDiv = document.getElementById('realtime-log');
            const timestamp = new Date().toLocaleTimeString();
            
            const summary = currentScan.summary;
            const logEntry = `[${timestamp}] üîÑ Cookies: ${summary.cookies.total} | Scripts: ${summary.scripts.total} | Bloccati: ${summary.scripts.blocked}\n`;
            
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Mantieni solo le ultime 20 righe
            const lines = logDiv.textContent.split('\n');
            if (lines.length > 20) {
                logDiv.textContent = lines.slice(-20).join('\n');
            }
        }
        
        // Inizializzazione automatica
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Pagina di test Cookie Banner System 2.0 caricata');
            console.log('üí° Clicca "Carica Cookie Banner" per iniziare i test');
            
            // Auto-carica il sistema dopo 2 secondi
            setTimeout(() => {
                console.log('‚è≥ Auto-caricamento del sistema cookie...');
                loadCookieScript();
            }, 2000);
            
            // Aggiorna le statistiche ogni 5 secondi
            setInterval(updateRealtimeStats, 5000);
        });
        
        // Event listener per eventi personalizzati
        window.addEventListener('cookieSystemReady', function(event) {
            console.log('üéâ Sistema cookie completamente inizializzato!');
            console.log('üìä Dettagli sistema:', event.detail);
            
            // Avvia test automatici
            setTimeout(() => {
                console.log('üß™ Avvio test automatici...');
                addTestCookies();
                setTimeout(scanEverything, 1000);
            }, 2000);
        });
    </script>
</body>
</html> 